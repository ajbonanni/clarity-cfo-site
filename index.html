<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ClarityCFO.ai</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">

<header class="bg-white shadow p-4 flex justify-between items-center">
  <h1 class="text-xl font-bold text-blue-600">ClarityCFO.ai</h1>
</header>

<section id="file-upload" class="bg-gray-50 py-16 px-6">
  <div class="max-w-xl mx-auto text-center">
    <h3 class="text-3xl font-bold mb-6">Upload Your Financials</h3>
    <p class="mb-4">We support .csv, .xlsx, and .pdf — exported from your accounting system.</p>
    <input type="file" id="fileInput" class="block w-full p-3 border rounded mb-4" accept=".csv,.xlsx,.pdf"/>
    <button onclick="uploadFile()" class="bg-blue-600 text-white px-6 py-3 rounded">Upload File</button>
    <p id="uploadStatus" class="mt-4 text-green-600 hidden"></p>
    <div id="diagnosticResults" class="mt-6 p-4 bg-yellow-50 border border-yellow-300 rounded text-yellow-900 hidden"></div>
    <div id="aiNarrative" class="mt-6 text-sm italic text-gray-600 hidden"></div>
  </div>
</section>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCfYTgv1MVWfDezRV-i00oL9ca3f56auFc",
    authDomain: "clarity-cfo.firebaseapp.com",
    projectId: "clarity-cfo",
    storageBucket: "clarity-cfo.firebasestorage.app",
    messagingSenderId: "744282604632",
    appId: "1:744282604632:web:33f064b034e82a9c40f62d"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();

  async function getGenAIDiagnostics(data) {
  try {
    const response = await fetch("/api/diagnose", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(data)
    });

    return await response.json();
  } catch (error) {
    console.error("🛑 Diagnostic API Error:", error);
    return {
      flags: ["⚠️ AI diagnostic unavailable"],
      summary: "AI failed to analyze your file. Please try again later.",
      narrative: "No narrative available."
    };
  }
}


  function uploadFile() {
    const fileInput = document.getElementById("fileInput");
    const file = fileInput.files[0];
    const uploadStatus = document.getElementById("uploadStatus");
    const diagnosticBox = document.getElementById("diagnosticResults");
    const aiNarrative = document.getElementById("aiNarrative");

    uploadStatus.classList.add("hidden");
    diagnosticBox.classList.add("hidden");
    aiNarrative.classList.add("hidden");
    uploadStatus.innerHTML = "";
    diagnosticBox.innerHTML = "";
    aiNarrative.innerHTML = "";

    if (!file) {
      alert("Please select a file.");
      return;
    }

    const ext = file.name.toLowerCase().split('.').pop();
    uploadStatus.textContent = "⏳ Uploading...";
    uploadStatus.classList.remove("hidden");

    if (ext === "csv") {
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: (results) => handleFinancialData(results.data, file.name)
      });
    } else if (ext === "xlsx") {
      const reader = new FileReader();
      reader.onload = function(e) {
        const wb = XLSX.read(e.target.result, { type: 'array' });
        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        handleFinancialData(data, file.name);
      };
      reader.readAsArrayBuffer(file);
    } else if (ext === "pdf") {
      const ref = storage.ref().child("uploads/" + file.name);
      ref.put(file).then(() => {
        uploadStatus.textContent = "📄 PDF uploaded to Firebase Storage.";
      }).catch(() => {
        uploadStatus.textContent = "❌ Failed to upload PDF.";
      });
    } else {
      uploadStatus.textContent = "❌ Unsupported file type.";
    }

    fileInput.value = "";
  }

  async function handleFinancialData(data, filename) {
    let revenue = 0, expenses = 0;
    data.forEach(row => {
      const name = row["Account"]?.toLowerCase();
      const amount = parseFloat(row["Amount"] || row["Value"] || 0);
      if (name?.includes("revenue")) revenue += amount;
      if (name?.includes("expense")) expenses += amount;
    });

    const burn = expenses - revenue;
    const format = n => n.toLocaleString('en-US', { style: 'currency', currency: 'USD' });

    document.getElementById("uploadStatus").textContent =
      `📊 Revenue: ${format(revenue)} | Expenses: ${format(expenses)} | Burn: ${format(burn)} ✅ File successfully uploaded`;

    const diagnostics = await getGenAIDiagnostics({ revenue, expenses, burn, filename });

    const diagnosticBox = document.getElementById("diagnosticResults");
    diagnosticBox.classList.remove("hidden");
    diagnosticBox.innerHTML = `
      <h4 class="font-bold mb-2">AI Diagnostic Summary:</h4>
      <ul class="list-disc list-inside">
        ${diagnostics.flags.map(f => `<li>${f}</li>`).join("")}
      </ul>
      <p class="mt-2 text-sm text-gray-700">${diagnostics.summary}</p>
    `;

    const aiNarrative = document.getElementById("aiNarrative");
    aiNarrative.textContent = `🧠 GPT Insight: ${diagnostics.narrative}`;
    aiNarrative.classList.remove("hidden");

    db.collection("financial_uploads").add({
      filename, revenue, expenses, burn,
      flags: diagnostics.flags,
      summary: diagnostics.summary,
      narrative: diagnostics.narrative,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
  }
</script>
</body>
</html>
